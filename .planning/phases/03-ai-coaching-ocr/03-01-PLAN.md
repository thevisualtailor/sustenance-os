---
phase: 03-ai-coaching-ocr
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/chat/claude-api.js
  - src/chat/session-context.js
  - src/main.js
autonomous: true

must_haves:
  truths:
    - "User is prompted for their Anthropic API key on first load"
    - "API key is stored in localStorage and persists across reloads"
    - "Claude Haiku 4.5 API can be called from the browser with no CORS errors"
    - "Session context stores parsed data without ever rendering it in the chat thread"
  artifacts:
    - path: "src/chat/claude-api.js"
      provides: "Anthropic API client replacing getStubResponse"
      exports: ["sendMessage", "getApiKey", "setApiKey", "hasApiKey"]
    - path: "src/chat/session-context.js"
      provides: "Hidden session data store for OCR/XLSX data"
      exports: ["setOcrData", "setXlsxData", "getContextBlock", "clearSession"]
    - path: "src/main.js"
      provides: "API key gate before chat view mounts"
  key_links:
    - from: "src/chat/claude-api.js"
      to: "https://api.anthropic.com/v1/messages"
      via: "fetch with CORS header"
      pattern: "anthropic-dangerous-direct-browser-access.*true"
    - from: "src/main.js"
      to: "src/chat/claude-api.js"
      via: "hasApiKey() check before mounting chat"
      pattern: "hasApiKey"
---

<objective>
Create the Claude API client and session context infrastructure that powers all coaching interactions in Phase 3.

Purpose: This is the backbone -- every other plan depends on being able to call Claude Haiku and store parsed nutrition data in a hidden session context. Also gates the app on API key entry so the user can start using real AI immediately.
Output: claude-api.js (API client), session-context.js (hidden data store), API key entry overlay in main.js
</objective>

<execution_context>
@/Users/jaycarter/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jaycarter/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-coaching-ocr/03-RESEARCH.md
@src/main.js
@src/chat/chat-view.js
@src/chat/message-store.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Claude API client and session context modules</name>
  <files>src/chat/claude-api.js, src/chat/session-context.js</files>
  <action>
Create `src/chat/claude-api.js` with:
- Constants: `ANTHROPIC_API_URL = 'https://api.anthropic.com/v1/messages'`, `MODEL = 'claude-haiku-4-5-20251001'` (NOT claude-3-haiku — deprecated)
- `getApiKey()` / `setApiKey(key)` / `hasApiKey()` — read/write `sustenance_anthropic_key` in localStorage
- `sendMessage({ systemPrompt, messages })` — async function that calls the Anthropic Messages API via fetch. MUST include ALL four headers: `x-api-key`, `anthropic-version: '2023-06-01'`, `content-type: application/json`, `anthropic-dangerous-direct-browser-access: 'true'` (this header is REQUIRED for browser CORS — without it the preflight fails). Body: `{ model: MODEL, max_tokens: 1024, system: systemPrompt, messages }`. On non-OK response, parse error JSON and throw with `err.error.message`. On success, return `data.content[0].text`.
- `sendOcrExtraction({ base64, mediaType })` — async function specifically for the OCR extraction call (two-call pipeline step 1). Uses a data-extraction system prompt that returns JSON only. max_tokens: 512. The system prompt instructs: extract nutrition data from MacroFactor screenshot, return JSON with `{ date, meals: [{ name, calories, protein, fat, carbs }], dailyTotal: { calories, protein, fat, carbs }, dailyTarget: { calories, protein, fat, carbs } }`. No commentary, JSON only. Messages array: single user message with image content block `{ type: 'image', source: { type: 'base64', media_type, data } }` and text block `{ type: 'text', text: 'Extract the nutrition data from this screenshot.' }`.
- Helper: `fileToBase64(file)` — returns Promise that resolves to raw base64 string (no data URL prefix). Uses FileReader.readAsDataURL, splits on comma to strip prefix.

Create `src/chat/session-context.js` with:
- Module-level `_sessionContext = { ocrData: null, xlsxData: null }`
- `setOcrData(data)` — stores parsed OCR JSON in session context
- `setXlsxData(data)` — stores parsed XLSX data in session context
- `getContextBlock()` — returns a string block for injection into the system prompt. Format: `[COACH CONTEXT — NOT FOR DISPLAY]\nOCR Data: ...\nXLSX Data: ...`. Returns empty string if no data loaded.
- `clearSession()` — resets both to null (for new conversation)

Both files follow the feature module pattern (plain functions, no class syntax). Import CSS: neither file has CSS (pure logic modules).
  </action>
  <verify>
Run `npm run build` — no import errors, no syntax errors. Verify the exports exist by checking the file contents.
  </verify>
  <done>
claude-api.js exports sendMessage, sendOcrExtraction, fileToBase64, getApiKey, setApiKey, hasApiKey. session-context.js exports setOcrData, setXlsxData, getContextBlock, clearSession. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: API key entry overlay on first load</name>
  <files>src/main.js, src/chat/chat-view.css</files>
  <action>
Modify `src/main.js`:
- Import `hasApiKey`, `setApiKey` from `./chat/claude-api.js`
- In the `init()` function, BEFORE calling `createChatView(main)`, check `hasApiKey()`:
  - If true: proceed to mount chat view as before
  - If false: show an API key entry overlay

The API key overlay:
- Create a full-screen overlay div (class `api-key-overlay`) appended to `main`
- Center-aligned content: title "API Key Required", subtitle explaining this is a personal app that calls Claude directly, an `<input type="password">` for the key, and a "Continue" button
- On button click (or Enter keydown on the input): read the input value, validate it's not empty, call `setApiKey(value)`, remove the overlay, then call `createChatView(main)` to mount the chat
- Style the overlay to match the app's dark theme (use existing CSS custom properties: --bg, --text-primary, --text-secondary, --bg-surface, --border, --font-body)

Add overlay styles to `src/chat/chat-view.css` (co-located with the chat feature since it gates the chat):
- `.api-key-overlay`: position fixed, inset 0, background var(--bg), display flex, flex-direction column, align-items center, justify-content center, padding 24px, z-index 100
- `.api-key-overlay h2`: font-family var(--font-heading), font-size 20px, margin-bottom 8px, color var(--text-primary)
- `.api-key-overlay p`: font-size 13px, color var(--text-secondary), max-width 300px, text-align center, margin-bottom 24px, line-height 1.5
- `.api-key-overlay input`: same styling as `.chat-input textarea` (bg-surface, border, border-radius 12px, padding 10px 14px, font-size 16px, color text-primary, width 100%, max-width 300px, box-sizing border-box)
- `.api-key-overlay button`: same styling as `.chat-input__send` but wider (width auto, padding 10px 24px, border-radius 12px, margin-top 12px, font-size 14px, font-family var(--font-body))

Do NOT create a separate CSS file for this — it's a small addition to the existing chat-view.css.
  </action>
  <verify>
Run `npm run dev` and open in browser. If no API key is stored, the overlay should appear. Enter any string and click Continue — the overlay should disappear and the chat view should mount. Reload the page — the chat view should appear directly (key persisted). Verify by checking `localStorage.getItem('sustenance_anthropic_key')` in the browser console.
  </verify>
  <done>
First load shows API key overlay. Entering a key and clicking Continue stores it and mounts chat. Subsequent loads skip the overlay. Build succeeds with no errors.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no errors
- claude-api.js uses model `claude-haiku-4-5-20251001` (not deprecated claude-3-haiku)
- claude-api.js includes `anthropic-dangerous-direct-browser-access: true` header
- session-context.js never exports raw number data for rendering
- API key overlay blocks chat until key is provided
- API key persists in localStorage across page reloads
</verification>

<success_criteria>
The API infrastructure is ready: Claude API client can send messages and extract OCR data, session context can store hidden nutrition data, and the app gates on API key entry. Plans 02 and 03 can build on this foundation.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-coaching-ocr/03-01-SUMMARY.md`
</output>
