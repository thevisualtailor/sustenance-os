---
phase: 03-ai-coaching-ocr
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/chat/upload-modal.js
  - src/chat/upload-modal.css
  - src/chat/chat-view.js
  - src/chat/chat-view.css
  - src/chat/message-store.js
  - src/chat/message-renderer.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "User sees a + button in the input bar (bottom-left, same row as send button)"
    - "Tapping + opens a modal with Camera / Photos / Files tiles on dark background with X dismiss"
    - "Selecting a photo from Camera or Photos shows a thumbnail and sends immediately"
    - "Selecting a .xlsx file sends immediately with auto-generated prompt"
    - "Uploaded image renders as a thumbnail in the user's message bubble (like iMessage)"
  artifacts:
    - path: "src/chat/upload-modal.js"
      provides: "Three-tile upload modal (Camera/Photos/Files)"
      exports: ["createUploadModal"]
    - path: "src/chat/upload-modal.css"
      provides: "Modal overlay and tile styles"
    - path: "src/chat/chat-view.js"
      provides: "+ button in input bar, file handling callbacks"
      contains: "upload-modal"
    - path: "src/chat/message-store.js"
      provides: "Attachment field on messages"
      contains: "attachment"
    - path: "src/chat/message-renderer.js"
      provides: "Image thumbnail rendering in user bubbles"
      contains: "img"
  key_links:
    - from: "src/chat/chat-view.js"
      to: "src/chat/upload-modal.js"
      via: "createUploadModal import, + button click handler"
      pattern: "createUploadModal"
    - from: "src/chat/message-renderer.js"
      to: "message.attachment"
      via: "checks attachment field, renders img thumbnail"
      pattern: "attachment"
    - from: "src/chat/upload-modal.js"
      to: "onImage|onFile callbacks"
      via: "file input change events trigger callbacks"
      pattern: "onImage|onFile"
---

<objective>
Build the upload UI: the + button in the input bar, the Camera/Photos/Files modal, image thumbnails in message bubbles, and XLSX file handling via SheetJS.

Purpose: Users need to get MacroFactor data into the app -- either by snapping a screenshot or uploading an XLSX export. This plan builds the entire upload flow UI without wiring the AI pipeline (that's Plan 03).
Output: upload-modal.js/css (new), modified chat-view.js (+ button), modified message-store.js (attachment field), modified message-renderer.js (thumbnails), SheetJS installed
</objective>

<execution_context>
@/Users/jaycarter/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jaycarter/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-coaching-ocr/03-RESEARCH.md
@src/chat/chat-view.js
@src/chat/chat-view.css
@src/chat/message-store.js
@src/chat/message-renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SheetJS + upload modal with + button</name>
  <files>package.json, src/chat/upload-modal.js, src/chat/upload-modal.css, src/chat/chat-view.js, src/chat/chat-view.css</files>
  <action>
**Step 1: Install SheetJS** (MUST use CDN tarball, NOT `npm install xlsx` which gets an outdated package):
```bash
npm install --save https://cdn.sheetjs.com/xlsx-0.20.3/xlsx-0.20.3.tgz
```

**Step 2: Create `src/chat/upload-modal.js`**

Export `createUploadModal({ onImage, onFile, onDismiss })`:
- Creates an overlay div (class `upload-modal-overlay`) that covers the viewport
- Contains a modal content div (class `upload-modal`) with:
  - X dismiss button (top-right, class `upload-modal__dismiss`) — calls `onDismiss` and removes overlay
  - Three large tappable tiles (class `upload-modal__tile`), each with an icon and label:
    - **Camera** tile: icon is a camera SVG, label "Camera". Clicking triggers a hidden `<input type="file" accept="image/*" capture="environment">`. On change, calls `onImage(file)` and closes modal.
    - **Photos** tile: icon is a photos/gallery SVG, label "Photos". Clicking triggers a hidden `<input type="file" accept="image/*">` (NO capture attribute — this opens the photo library, not camera). On change, calls `onImage(file)` and closes modal.
    - **Files** tile: icon is a document SVG, label "Files". Clicking triggers a hidden `<input type="file" accept=".xlsx,.xls">`. On change, calls `onFile(file)` and closes modal.
- Clicking the overlay background (outside the modal content) also dismisses
- Hidden file inputs are appended to the overlay (not visible)
- `close()` function removes overlay from DOM and resets file input values (so re-opening works)
- Returns `{ open, close }` — `open()` appends overlay to document.body

IMPORTANT: Each hidden input's `value` must be reset to `''` in the `close()` function so re-selecting the same file triggers the change event again.

SVG icons should be simple, lightweight, inline SVGs (similar size/style to existing header buttons — stroke-based, 24x24 viewBox, currentColor).

**Step 3: Create `src/chat/upload-modal.css`**

Import in upload-modal.js (`import './upload-modal.css'`).

Styles:
- `.upload-modal-overlay`: position fixed, inset 0, background rgba(0,0,0,0.85), display flex, align-items center, justify-content center, z-index 200, padding 24px
- `.upload-modal`: background var(--bg-surface), border-radius 16px, padding 24px, width 100%, max-width 320px, display flex, flex-direction column, gap 12px
- `.upload-modal__dismiss`: position absolute, top 12px, right 12px, width 36px, height 36px, background none, border none, color var(--text-secondary), cursor pointer, display flex, align-items center, justify-content center, font-size 20px. Use an X SVG or Unicode X.
- `.upload-modal__tile`: display flex, align-items center, gap 16px, padding 16px, background var(--bg-elevated), border-radius 12px, border none, color var(--text-primary), font-family var(--font-body), font-size 15px, cursor pointer, width 100%, min-height 56px, transition background 0.15s ease. On `:active`: background with slightly lighter shade.
- `.upload-modal__tile svg`: width 24px, height 24px, color var(--text-secondary), flex-shrink 0
- Relative position on `.upload-modal` for the absolute dismiss button

**Step 4: Modify `src/chat/chat-view.js`**

Add + button to the input bar:
- Import `createUploadModal` from `./upload-modal.js`
- Create a `+` button (class `chat-input__attach`, same size as send button: 44x44px) with a `+` icon (use a simple SVG: circle with plus, or just a plus sign)
- Insert the `+` button BEFORE the textarea in the input bar: `inputBar.insertBefore(attachBtn, textarea)` — so layout is: [+] [textarea] [send]
- On click, create and open the upload modal with callbacks:
  - `onImage(file)`: store the file reference for the next send (see Task 2 for how pending attachment works). For now, store it as `pendingAttachment = { type: 'image', file }`. Then trigger the send flow immediately per locked decision ("file alone is enough — selecting from the modal sends immediately"). Call `handleSendWithAttachment()` (a new function that sends the attachment with auto-generated text "Analyse this" if textarea is empty, or with textarea text if present).
  - `onFile(file)`: store as `pendingAttachment = { type: 'xlsx', file }`. Same immediate-send behavior.
  - `onDismiss`: no-op (just closes modal)

The `handleSendWithAttachment()` function:
- Takes the `pendingAttachment` and the current textarea value
- If textarea is empty, uses "Analyse this" as the text (per locked decision: "When a file-only message is sent, Claude should auto-generate a default prompt")
- Calls the normal message flow but passes the attachment along
- For now (before Plan 03 wires the AI pipeline), the attachment is stored on the message object but the response still comes from `getStubResponse()` — Plan 03 replaces this
- Clears `pendingAttachment` after send

**Step 5: Add + button styles to `src/chat/chat-view.css`**

`.chat-input__attach`: same dimensions and styling as `.chat-input__send` (44x44px, background #333, border-radius 12px, display flex, align-items center, justify-content center, border none, color var(--text-primary), cursor pointer, flex-shrink 0, padding 0, transition opacity 0.15s ease). `:active` state: opacity 0.75.
  </action>
  <verify>
Run `npm run build` — no errors, SheetJS is in node_modules. Run `npm run dev` — the chat input bar shows [+] [textarea] [send]. Tap + — modal opens with three tiles and X dismiss. Tap X or overlay — modal closes. Tap Camera/Photos/Files — triggers OS file picker (visual verification).
  </verify>
  <done>
SheetJS installed. + button visible in input bar. Modal opens with Camera/Photos/Files tiles. File selection triggers appropriate picker. Modal dismisses on X or overlay tap. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Message attachments — store, render thumbnails, XLSX parsing</name>
  <files>src/chat/message-store.js, src/chat/message-renderer.js</files>
  <action>
**Step 1: Modify `src/chat/message-store.js`**

Update `addMessage(role, content, attachment = null)`:
- Add optional third parameter `attachment` (default null)
- The message object now includes `attachment`: `{ id, role, content, timestamp, attachment }`
- Attachment shape for images: `{ type: 'image', url: string }` (a blob URL for display)
- Attachment shape for XLSX: `{ type: 'xlsx', filename: string, data: object }` (parsed data)
- Existing callers that pass only `(role, content)` are unaffected due to default parameter

Add a helper exported function `createImageAttachment(file)`:
- Takes a File object, creates a blob URL via `URL.createObjectURL(file)`
- Returns `{ type: 'image', url: blobUrl, file }` (keeps the File reference for base64 conversion later in Plan 03)

Add a helper exported function `createXlsxAttachment(file)`:
- Import `{ read, utils }` from `'xlsx'` (SheetJS)
- Returns a Promise. Reads the file as ArrayBuffer via FileReader
- Parses: `const workbook = read(arrayBuffer)`. Extract `dailyRows = utils.sheet_to_json(workbook.Sheets['Quick Export'])` and `foodRows = utils.sheet_to_json(workbook.Sheets['Food Log'])` — sheet names are EXACTLY 'Quick Export' and 'Food Log' (with spaces, verified from actual MacroFactor exports)
- Returns `{ type: 'xlsx', filename: file.name, data: { dailyRows, foodRows } }`

**Step 2: Modify `src/chat/message-renderer.js`**

Update `renderMessage(message)` to handle attachments:
- After creating the content div, check `message.attachment`:
  - If `attachment.type === 'image'`: create an `<img>` element (class `message__thumbnail`) with `src = attachment.url`, `alt = "Uploaded screenshot"`. Style inline or via CSS: `max-width: 200px`, `max-height: 200px`, `border-radius: 12px`, `margin-bottom: 6px`, `display: block`. Insert the image BEFORE the text content in the wrapper (so thumbnail appears above the text in the user's bubble, like iMessage).
  - If `attachment.type === 'xlsx'`: create a div (class `message__file-badge`) with a document icon and the filename. Style: small pill/badge showing the filename, subtle background.
- For user messages with attachments, the wrapper still uses `message--user` class — the thumbnail sits inside the bubble.

Add CSS for thumbnails and file badges to `src/chat/chat-view.css` is NOT this task's responsibility (Plan 02 Task 1 already added upload-modal.css; thumbnail/badge styles should go in chat-view.css). Add these styles inline in message-renderer.js OR add a small block to chat-view.css:
- `.message__thumbnail`: max-width 200px, max-height 200px, border-radius 12px, display block, margin-bottom 6px, object-fit cover
- `.message__file-badge`: display inline-flex, align-items center, gap 6px, background var(--bg-surface), border-radius 8px, padding 6px 10px, font-size 12px, color var(--text-secondary), margin-bottom 6px

Add these CSS rules to `src/chat/chat-view.css` (at the message bubbles section).
  </action>
  <verify>
Run `npm run build` — no errors. In the running dev server, use the + button to select an image via Photos. The image should appear as a thumbnail in a user message bubble. The message text should show "Analyse this" (auto-generated). For XLSX: select a .xlsx file — a file badge with the filename should appear in the user message bubble.
  </verify>
  <done>
Messages support attachment field (image or xlsx). Image attachments render as thumbnails in user bubbles (iMessage-style). XLSX files parse via SheetJS and show a filename badge. Auto-generated "Analyse this" text appears for file-only sends. Build succeeds.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- + button is visible in input bar, left of textarea
- Modal opens on + tap with Camera / Photos / Files tiles
- Camera triggers camera (mobile) or file picker (desktop)
- Photos triggers photo library
- Files triggers .xlsx picker
- Image selected from modal sends immediately with "Analyse this" text
- Image appears as thumbnail in user message bubble
- XLSX selected from modal sends immediately with filename badge
- SheetJS parses Quick Export and Food Log sheets correctly (exact names with spaces)
- Modal dismisses on X, overlay tap, or after file selection
</verification>

<success_criteria>
The complete upload flow works end-to-end: + button opens modal, file selection triggers immediate send with attachment, images render as thumbnails in user bubbles, XLSX files are parsed and stored on the message. The AI response is still the Phase 2 stub — Plan 03 wires the real pipeline.
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-coaching-ocr/03-02-SUMMARY.md`
</output>
